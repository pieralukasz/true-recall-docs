---
export const prerender = true;

import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
---

<StarlightPage frontmatter={{ title: 'Create Account', template: 'splash', editUrl: false, tableOfContents: false }}>
	<div class="auth-container">
		<h1>Create an account</h1>
		<p class="subtitle">Sign up to start using True Recall credits</p>

		<div class="card">
			<div id="error-message" class="error-message" style="display: none;"></div>
			<div id="success-message" class="success-message" style="display: none;"></div>

			<form id="register-form">
				<div class="form-group">
					<label for="email">Email</label>
					<input type="email" id="email" name="email" required placeholder="you@example.com" />
				</div>

				<div class="form-group">
					<label for="password">Password</label>
					<input type="password" id="password" name="password" required minlength="6" placeholder="Min. 6 characters" />
				</div>

				<div class="form-group">
					<label for="confirm-password">Confirm Password</label>
					<input type="password" id="confirm-password" name="confirm-password" required placeholder="Confirm your password" />
				</div>

				<button type="submit" class="btn" style="width: 100%;">Create Account</button>
			</form>
		</div>

		<p class="alt-action">
			Already have an account? <a href="/login">Sign in</a>
		</p>
	</div>
</StarlightPage>

<script>
	import { supabase } from '../lib/supabase';

	const form = document.getElementById('register-form') as HTMLFormElement;
	const errorMessage = document.getElementById('error-message') as HTMLDivElement;
	const successMessage = document.getElementById('success-message') as HTMLDivElement;

	// Check if already logged in
	supabase.auth.getSession().then(({ data: { session } }) => {
		if (session) {
			window.location.href = '/dashboard';
		}
	});

	form.addEventListener('submit', async (e) => {
		e.preventDefault();
		errorMessage.style.display = 'none';
		successMessage.style.display = 'none';

		const email = (document.getElementById('email') as HTMLInputElement).value;
		const password = (document.getElementById('password') as HTMLInputElement).value;
		const confirmPassword = (document.getElementById('confirm-password') as HTMLInputElement).value;

		// Validate passwords match
		if (password !== confirmPassword) {
			errorMessage.textContent = 'Passwords do not match.';
			errorMessage.style.display = 'block';
			return;
		}

		const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
		submitBtn.disabled = true;
		submitBtn.textContent = 'Creating account...';

		try {
			const { data, error } = await supabase.auth.signUp({
				email,
				password,
				options: {
					emailRedirectTo: `${window.location.origin}/auth/callback`,
				},
			});

			if (error) {
				errorMessage.textContent = error.message;
				errorMessage.style.display = 'block';
				submitBtn.disabled = false;
				submitBtn.textContent = 'Create Account';
				return;
			}

			if (data.user) {
				// Check if email confirmation is required
				if (data.user.identities && data.user.identities.length === 0) {
					errorMessage.textContent = 'This email is already registered. Please sign in instead.';
					errorMessage.style.display = 'block';
					submitBtn.disabled = false;
					submitBtn.textContent = 'Create Account';
					return;
				}

				successMessage.innerHTML = `
					Account created successfully!<br>
					Please check your email to verify your account.
				`;
				successMessage.style.display = 'block';
				form.style.display = 'none';
			}
		} catch (err) {
			errorMessage.textContent = 'An unexpected error occurred. Please try again.';
			errorMessage.style.display = 'block';
			submitBtn.disabled = false;
			submitBtn.textContent = 'Create Account';
		}
	});
</script>
