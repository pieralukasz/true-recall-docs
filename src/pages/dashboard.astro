---
export const prerender = true;

import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
---

<StarlightPage frontmatter={{ title: 'Dashboard', editUrl: false, tableOfContents: false }}>
	<div id="loading" class="loading-container">
		Loading...
	</div>

	<div class="dashboard" id="dashboard-content" style="display: none;">
		<h1>Welcome back!</h1>
		<p>Signed in as <span id="user-email"></span></p>

		<div class="credits-card">
			<h2>Your Credits</h2>
			<span class="balance" id="credits-balance">0</span>
			<span class="label">credits available</span>
			<a href="/pricing" class="btn">Buy Credits</a>
		</div>

		<div class="card" style="margin-top: 2rem;">
			<h2 style="margin-bottom: 1rem;">Quick Actions</h2>
			<div style="display: flex; gap: 1rem; flex-wrap: wrap;">
				<a href="/" class="btn btn-secondary">View Documentation</a>
				<button id="logout" class="btn btn-secondary">Sign Out</button>
			</div>
		</div>

		<div class="card" style="margin-top: 1.5rem;">
			<h2 style="margin-bottom: 0.5rem;">Using Credits</h2>
			<p style="color: var(--sl-color-gray-3); font-size: 0.9rem;">
				Credits are used to generate flashcards when you don't have your own API key configured in the True Recall plugin.
				Each flashcard generation uses approximately 1-5 credits depending on the content length.
			</p>
		</div>
	</div>
</StarlightPage>

<script>
	import { supabase } from '../lib/supabase';

	const loadingEl = document.getElementById('loading');
	const dashboardEl = document.getElementById('dashboard-content');
	const userEmailEl = document.getElementById('user-email');

	// Client-side auth check
	async function checkAuth() {
		const { data: { session } } = await supabase.auth.getSession();

		if (!session) {
			window.location.href = '/login';
			return;
		}

		// User is authenticated - show dashboard
		if (loadingEl) loadingEl.style.display = 'none';
		if (dashboardEl) dashboardEl.style.display = 'block';
		if (userEmailEl) userEmailEl.textContent = session.user.email || '';

		// TODO: Fetch credits from Supabase
		// const { data: credits } = await supabase
		//   .from('user_credits')
		//   .select('balance')
		//   .eq('user_id', session.user.id)
		//   .single();
		// if (credits) {
		//   document.getElementById('credits-balance').textContent = credits.balance.toString();
		// }
	}

	checkAuth();

	// Logout handler
	document.getElementById('logout')?.addEventListener('click', async () => {
		await supabase.auth.signOut();

		// Clear cookies
		document.cookie = 'sb-access-token=; Max-Age=0; path=/';
		document.cookie = 'sb-refresh-token=; Max-Age=0; path=/';

		window.location.href = '/login';
	});
</script>
